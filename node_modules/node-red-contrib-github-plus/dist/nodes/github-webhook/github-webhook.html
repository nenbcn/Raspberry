<script type="text/javascript">
(function () {
    'use strict';

    var githubWebhookCredentials = {
        secret: { type: "text" },
    };

    RED.nodes.registerType("github-webhook", {
        category: "github",
        color: "#9CDAF1",
        defaults: {
            path: { value: "", required: true },
            name: { value: "" },
        },
        credentials: githubWebhookCredentials,
        inputs: 0,
        outputs: 1,
        icon: "github-logo.svg",
        paletteLabel: "webhook",
        label: function () {
            if (this.name) {
                return this.name;
            }
            if (this.path) {
                var path = RED.settings.httpNodeRoot || "";
                if (path.slice(-1) !== "/") {
                    path = path + "/";
                }
                if (this.path.charAt(0) === "/") {
                    path += this.path.slice(1);
                }
                else {
                    path += this.path;
                }
                return path;
            }
            else {
                return "github webhook";
            }
        },
        oneditprepare: function () {
            var root = RED.settings.httpNodeRoot || "";
            if (root.slice(-1) == "/") {
                root = root.slice(0, -1);
            }
            if (root == "") {
                $("#form-tips").hide();
            }
            else {
                $("#form-tips-path").html(root);
                $("#form-tips").show();
            }
            $("#generateSecret").on("click", function (evt) {
                evt.preventDefault();
                var secretChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
                var arr = new Uint8Array(40);
                window.crypto.getRandomValues(arr);
                arr = arr.map(function (x) { return secretChars.charCodeAt(x % secretChars.length); });
                var secret = "";
                arr.forEach(function (byte) {
                    secret += String.fromCharCode(byte);
                });
                $("#node-input-secret").val(secret);
            });
        },
        oneditsave: function () {
            var _a;
            var val = ((_a = $("#node-input-path").val()) === null || _a === void 0 ? void 0 : _a.toString()) || "";
            val = val.trim();
            if (val.length > 0) {
                if (val.substr(0, 1) !== "/") {
                    val = "/" + val;
                }
            }
            $("#node-input-path").val(val);
        },
    });

}());
</script>
<script type="text/html" data-template-name="github-webhook">
  <div class="form-row">
    <label for="node-input-path"
      ><i class="fa fa-angle-right"></i>
      Path
    </label>
    <input type="text" id="node-input-path" placeholder="/github-webhook" />
  </div>

  <div class="form-row">
    <label for="node-input-secret"><i class="fa fa-key"></i> Secret</label>
    <input type="text" id="node-input-secret">
  </div>
  <div class="form-row">
    <label></label>
    <button
      type="button"
      id="generateSecret"
      class="red-ui-button">
      Generate Secret
    </button>
  </div>

  <hr />

  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>

<script type="text/html" data-help-name="github-webhook">
  <p>
    Creates a HTTP endpoint on your server to listen to GitHub webhooks.
  </p>

  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>guid <span class="property-type">string</span></dt>
    <dd>
      A GUID to identify the delivery. Value of <code>X-GitHub-Delivery</code> header.
    </dd>
    <dt>topic <span class="property-type">string</span></dt>
    <dd>
      Name of the event that triggered the delivery. Value of <code>X-GitHub-Event</code> header.
    </dd>
    <dt>payload <span class="property-type">object</span></dt>
    <dd>
      Webhook event payload. For a complete list of payload object properties and their
      details review the
      <a
        href="https://docs.github.com/en/free-pro-team@latest/developers/webhooks-and-events/webhook-events-and-payloads"
        rel="noreferrer noopener"
        >Webhook events and payloads
      </a>
      documentation.
    </dd>
  </dl>

  <h3>Details</h3>
  <p>
    The node will listen on the configured url path to handle incoming webhook payloads.
  </p>

  <h3>References</h3>
  <ul>
    <li>
      <a href="https://github.com/redbtc/node-red-contrib-github-plus#configuration">Configuration</a> - docs
      on configuring GitHub API client
    </li>
    <li>
      <a href="https://github.com/redbtc/node-red-contrib-github-plus#making-rest-api-requests">Making REST API Requests</a> -
      docs on making REST API requests with GitHub REST API Node
    </li>
    <li>
      <a href="https://github.com/redbtc/node-red-contrib-github-plus#handling-incoming-webhook-payloads">Handling Incoming Webhook Payloads</a> -
      docs on listening for GitHub events and receiving payload with GitHub Webhook Node
    </li>
    <li>
      <a href="https://github.com/redbtc/node-red-contrib-github-plus#examples">Example Flows</a> - examples made with GitHub nodes
    </li>
    <li>
      <a
        href="https://docs.github.com/en/free-pro-team@latest/rest/overview/endpoints-available-for-github-apps"
        rel="noreferrer noopener"
        >REST Endpoints available for GitHub Apps</a
      >
      - list of all REST endpoints your GitHub app can make requests to
    </li>
    <li>
      <a
        href="https://docs.github.com/en/free-pro-team@latest/rest/reference"
        rel="noreferrer noopener"
        >REST API Reference</a
      >
      - documentation to learn about the resources available in the GitHub REST API
    </li>
    <li>
      <a
        href="https://docs.github.com/en/free-pro-team@latest/rest/overview/media-types"
        rel="noreferrer noopener"
        >REST Media Types</a
      >
      - documentation to learn about custom media types in the GitHub REST API
    </li>
    <li>
      <a
        href="https://docs.github.com/en/free-pro-team@latest/developers/webhooks-and-events/webhook-events-and-payloads"
        rel="noreferrer noopener"
        >Webhook events and payloads</a
      >
      - documentation on webhook events and payloads
    </li>
    <li>
      <a href="https://github.com/redbtc/node-red-contrib-github-plus">GitHub</a> -
      project home on GitHub
    </li>
  </ul>
</script>
